name: Build 1.0.x

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v5
        with:
          ref: 'v1.0.x' 
          submodules: true

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up SDK
        uses: android-actions/setup-android@v3
        with:
          packages: 'platforms;android-36 build-tools;36.0.0'
      - name: Add SDK to PATH
        run: echo "$ANDROID_HOME/build-tools/36.0.0" >> $GITHUB_PATH

      - name: Set up NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r28c
          link-to-sdk: true
      - name: Add NDK to PATH
        run: echo "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Set up Android Manifest Merger
        run: |
          mkdir -p $HOME/ManifestMerger
          curl -Lo $HOME/ManifestMerger/manifest-merger.jar https://github.com/distriqt/android-manifest-merger/releases/download/v31.9.0/manifest-merger-31.9.0.jar
          echo -e "#!/bin/bash\njava -jar $HOME/ManifestMerger/manifest-merger.jar \"\$@\"" > $HOME/ManifestMerger/manifest-merger
          chmod +x $HOME/ManifestMerger/manifest-merger
          echo "$HOME/ManifestMerger" >> $GITHUB_PATH

      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '4.0.2'

      - name: Set up zip and unzip
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip

      - name: Set up AAPT2
        run: |
          mkdir -p $HOME/aapt2
          curl -Lo $HOME/aapt2/aapt2.jar https://dl.google.com/dl/android/maven2/com/android/tools/build/aapt2/8.13.0-13719691/aapt2-8.13.0-13719691-linux.jar
          unzip -o $HOME/aapt2/aapt2.jar -d $HOME/aapt2
          chmod +x $HOME/aapt2/aapt2
          echo "$HOME/aapt2" >> $GITHUB_PATH

      - name: Set up bundletool
        run: |
          mkdir -p $HOME/bundletool
          curl -Lo $HOME/bundletool/bundletool.jar https://github.com/google/bundletool/releases/download/1.18.1/bundletool-all-1.18.1.jar
          echo -e "#!/bin/bash\njava -jar $HOME/bundletool/bundletool.jar \"\$@\"" > $HOME/bundletool/bundletool
          chmod +x $HOME/bundletool/bundletool
          echo "$HOME/bundletool" >> $GITHUB_PATH

      - name: Build project
        run: |
          cmake -B Build/Debug \
                -G "Ninja"
          cmake --build Build/Debug
          cmake --build Build/Debug --target create_aab
          cmake --build Build/Debug --target create_apks_universal
          cmake -B Build/Release \
                -G "Ninja" \
                -DCMAKE_BUILD_TYPE=MinSizeRel
          cmake --build Build/Release
          cmake --build Build/Release --target create_aab
          cmake --build Build/Release --target create_apks_universal

      - name: Upload debug APKs
        uses: actions/upload-artifact@v4
        with:
          name: debug-apks
          path: ./Build/Debug/outputs/*.apk

      - name: Upload release APKs
        uses: actions/upload-artifact@v4
        with:
          name: release-apks
          path: ./Build/Release/outputs/*.apk

      - name: Upload debug AABs
        uses: actions/upload-artifact@v4
        with:
          name: debug-aabs
          path: ./Build/Debug/outputs/*.aab

      - name: Upload release AABs
        uses: actions/upload-artifact@v4
        with:
          name: release-aabs
          path: ./Build/Release/outputs/*.aab

      - name: Upload debug APK sets
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-sets
          path: ./Build/Debug/outputs/*.apks

      - name: Upload release APK sets
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-sets
          path: ./Build/Release/outputs/*.apks

      - name: Upload native debug symbols
        uses: actions/upload-artifact@v4
        with:
          name: native-debug-symbols
          path: ./Build/Release/outputs/native-debug-symbols.zip